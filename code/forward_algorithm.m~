function [ fMatrix ] = forward_algorithm( data,param,age_stack,ETable,rhos,phi )
%% This function generates the forward sum matrix through dynamic programming.

% L = length of data in the core
% T = length of age in the stack

% Inputs:
% data: a Lx3-matrix where the first column has the depth indexes and the
% third one has the del-O18 data
% param: a structure of parameters consisting of the following:
% param.mu: a 1xT-vector of means
% param.sigma: a 1xT-vector of standard deviations
% param.shift: a 1xC-vector of shifts
% age_stack: a 1xT-vector of ages in stack
% ETable: a LxT-matrix consisting of emission distributions for each
% del-O18 data. Each values are stored as their logarithmic values.
% rhos: a 3x1-cell where the first one is rho_table and the second one is
% grid.
% phi: a hyperparameter for controlling the length of unaligned regions.

% Outputs:
% fMatrix: a TxTxL-forward matrix computed by the forward algorithm

%% Define variables:
T = size(age_stack,2);
L = size(data,1);
fMatrix = zeros(T,T,L);
depth = data(:,1);
rho_table = rhos{1};
%grid1 = [log(0.9220),log(1.0850)];
%grid2 = rhos{3};
phi = log(phi);
n = 2;

%% Initial n = 2

emission = ETable(1,:)' + ETable(2,:); % include radiocarbon emision...?
transition = rho_table((age_stack - age_stack')./(depth - depth')); % rho_table...?
fMatrix(:,:,n) = emission + transition + phi; %phi...?

%% Iterative n > 2

emission = ETable(1,:)

disp('Forward algorithim is done.');

end


%% General questions for Taehee
% - Everything is log-probabilities so add not multiply...?
% - Use repmat...?
